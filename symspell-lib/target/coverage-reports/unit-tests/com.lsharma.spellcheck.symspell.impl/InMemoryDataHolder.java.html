<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InMemoryDataHolder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">symspell-lib</a> &gt; <a href="index.source.html" class="el_package">com.lsharma.spellcheck.symspell.impl</a> &gt; <span class="el_source">InMemoryDataHolder.java</span></div><h1>InMemoryDataHolder.java</h1><pre class="source lang-java linenums">
package com.lsharma.spellcheck.symspell.impl;

import com.lsharma.spellcheck.symspell.api.DataHolder;
import com.lsharma.spellcheck.symspell.api.HashFunction;
import com.lsharma.spellcheck.symspell.common.DictionaryItem;
import com.lsharma.spellcheck.symspell.common.SpellCheckSettings;
import com.lsharma.spellcheck.symspell.common.SpellHelper;
import com.lsharma.spellcheck.symspell.exception.SpellCheckException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;

/**
 * Class to create in memory dictionary for the items with term-&gt;frequency
 */
public class InMemoryDataHolder implements DataHolder {

  /**
   * Dictionary of unique correct spelling words, and the frequency count for each word
   */
<span class="fc" id="L23">  private Map&lt;String, Double&gt; wordsDictionary = new HashMap&lt;&gt;();</span>
<span class="fc" id="L24">  private Map&lt;String, Double&gt; bigramsDictionary = new HashMap&lt;&gt;();</span>

  /**
   * Dictionary of unique words that are  below the count threshold for being considered correct
   * spellings.
   */
<span class="fc" id="L30">  private Map&lt;String, Double&gt; belowThresholdWords = new HashMap&lt;&gt;();</span>

  /**
   * Dictionary that contains a mapping of lists of suggested correction words to the hashCodes of
   * the original words and the deletes derived from them. Collisions of hashCodes is tolerated,
   * because suggestions are ultimately verified via an edit distance function. A list of
   * suggestions might have a single suggestion, or multiple suggestions.
   */
<span class="fc" id="L38">  private Map&lt;Long, String[]&gt; deletes = new HashMap&lt;&gt;();</span>


  /**
   * Spell check settings to use the values while ingesting the terms.
   */
  private SpellCheckSettings spellCheckSettings;

  private HashFunction hashFunction;

  public InMemoryDataHolder(
      SpellCheckSettings spellCheckSettings,
<span class="fc" id="L50">      HashFunction hashFunction) {</span>
<span class="fc" id="L51">    this.spellCheckSettings = spellCheckSettings;</span>
<span class="fc" id="L52">    this.hashFunction = hashFunction;</span>
<span class="fc" id="L53">  }</span>

  /**
   * Create/Update an entry in the dictionary. For every word there are deletes with an edit
   * distance of 1...maxEditDistance created and added to the dictionary. Every delete entry has a
   * suggestions list, which points to the original term(s) it was created from. The dictionary may
   * be dynamically updated (word frequency and new words) at any time by calling addItem
   *
   * @param dictionaryItem {@link DictionaryItem}
   * @return True if the word was added as a new correctly spelled word, or False if the word is
   * added as a below threshold word, or updates an existing correctly spelled word.
   */
  @Override
  public boolean addItem(final DictionaryItem dictionaryItem) throws SpellCheckException {

<span class="pc bpc" id="L68" title="1 of 4 branches missed.">    if (dictionaryItem.getFrequency() &lt;= 0 &amp;&amp; spellCheckSettings.getCountThreshold() &gt; 0) {</span>
<span class="fc" id="L69">      return false;</span>
    }

<span class="fc" id="L72">    double frequency = dictionaryItem.getFrequency();</span>
<span class="fc" id="L73">    String key = dictionaryItem.getTerm();</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">    if (frequency &lt;= 0) {</span>
<span class="nc" id="L75">      frequency = 0;</span>
    }

    /*
     * look first in below threshold words, update count, and allow
     * promotion to correct spelling word if count reaches threshold
     * threshold must be &gt;1 for there to be the possibility of low
     * threshold words
     */

<span class="fc" id="L85">    frequency = addItemToBelowThreshold(key, frequency);</span>

<span class="fc bfc" id="L87" title="All 2 branches covered.">    if (frequency == Double.MIN_VALUE) {</span>
<span class="fc" id="L88">      return false;</span>
    }

    //Adding new threshold word
<span class="fc bfc" id="L92" title="All 2 branches covered.">    if (!addToDictionary(key, frequency)) {</span>
<span class="fc" id="L93">      return false;</span>
    }


    /*
     * edits/suggestions are created only once, no matter how often
     * word occurs. edits/suggestions are created as soon as the
     * word occurs in the corpus, even if the same term existed
     * before in the dictionary as an edit from another word
     */
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">    if (key.length() &gt; spellCheckSettings.getMaxLength()) {</span>
<span class="nc" id="L104">      spellCheckSettings.setMaxLength(key.length());</span>
    }

    //create deletes
<span class="fc" id="L108">    Set&lt;String&gt; editDeletes = SpellHelper</span>
<span class="fc" id="L109">        .getEditDeletes(key, spellCheckSettings.getMaxEditDistance(),</span>
<span class="fc" id="L110">            spellCheckSettings.getPrefixLength());</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">    for (String delete : editDeletes) {</span>
<span class="fc" id="L112">      Long hash = hashFunction.hash(delete);</span>
      String[] suggestions;
<span class="fc bfc" id="L114" title="All 2 branches covered.">      if (deletes.containsKey(hash)) {</span>
<span class="fc" id="L115">        suggestions = deletes.get(hash);</span>
<span class="fc" id="L116">        String[] newSuggestions = Arrays.copyOf(suggestions, suggestions.length + 1);</span>
<span class="fc" id="L117">        deletes.put(hash, newSuggestions);</span>
<span class="fc" id="L118">        suggestions = newSuggestions;</span>
<span class="fc" id="L119">      } else {</span>
<span class="fc" id="L120">        suggestions = new String[1];</span>
<span class="fc" id="L121">        deletes.put(hash, suggestions);</span>
      }
<span class="fc" id="L123">      suggestions[suggestions.length - 1] = key;</span>
<span class="fc" id="L124">    }</span>
<span class="fc" id="L125">    return true;</span>
  }


  private boolean addToDictionary(String key, double frequency) {
<span class="fc bfc" id="L130" title="All 2 branches covered.">    if (key.split(&quot;\\s+&quot;).length &gt; 1) {</span>
<span class="fc" id="L131">      bigramsDictionary.put(key, frequency);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">      if (frequency &lt; spellCheckSettings.getBigramCountMin()) {</span>
<span class="fc" id="L133">        spellCheckSettings.setBigramCountMin(frequency);</span>
      }
<span class="fc" id="L135">      return false;</span>
    } else {
<span class="fc" id="L137">      wordsDictionary.put(key, frequency);</span>
<span class="fc" id="L138">      return true;</span>
    }
  }


  @Override
  public Double getItemFrequency(String term) throws SpellCheckException {
<span class="fc" id="L145">    return wordsDictionary.getOrDefault(term, null);</span>
  }

  @Override
  public Double getItemFrequencyBiGram(String term) throws SpellCheckException {
<span class="fc" id="L150">    return bigramsDictionary.getOrDefault(term, null);</span>
  }

  @Override
  public String[] getDeletes(String key) {
<span class="fc" id="L155">    return deletes.getOrDefault(hashFunction.hash(key), null);</span>
  }

  @Override
  public int getSize() {
<span class="fc" id="L160">    return wordsDictionary.size();</span>
  }

  @Override
  public boolean clear() {
<span class="fc" id="L165">    wordsDictionary.clear();</span>
<span class="fc" id="L166">    deletes.clear();</span>
<span class="fc" id="L167">    belowThresholdWords.clear();</span>
<span class="fc" id="L168">    return false;</span>
  }

  private double addItemToBelowThreshold(String key, double frequency) {
<span class="fc bfc" id="L172" title="All 4 branches covered.">    if (spellCheckSettings.getCountThreshold() &gt; 1 &amp;&amp; belowThresholdWords.containsKey(key)) {</span>
<span class="fc" id="L173">      double prevFreq = belowThresholdWords.get(key);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">      frequency =</span>
          prevFreq + (Double.MAX_VALUE - prevFreq &gt; frequency ? frequency : Double.MAX_VALUE);
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">      if (frequency &gt; spellCheckSettings.getCountThreshold()) {</span>
<span class="fc" id="L177">        belowThresholdWords.remove(key);</span>
      } else {
<span class="nc" id="L179">        belowThresholdWords.put(key, frequency);</span>
<span class="nc" id="L180">        return Double.MIN_VALUE;</span>
      }
<span class="fc bfc" id="L182" title="All 2 branches covered.">    } else if (wordsDictionary.containsKey(key)) {</span>
<span class="fc" id="L183">      double prevFreq = wordsDictionary.get(key);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">      frequency =</span>
          prevFreq + (Double.MAX_VALUE - prevFreq &gt; frequency ? frequency : Double.MAX_VALUE);
<span class="fc" id="L186">      addToDictionary(key, frequency);</span>
<span class="fc" id="L187">      return Double.MIN_VALUE;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">    } else if (frequency &lt; spellCheckSettings.getCountThreshold()) {</span>
<span class="fc" id="L189">      belowThresholdWords.put(key, frequency);</span>
<span class="fc" id="L190">      return Double.MIN_VALUE;</span>
    }
<span class="fc" id="L192">    return frequency;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>